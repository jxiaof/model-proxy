# 构建阶段
FROM golang:1.25-alpine3.21 AS builder

WORKDIR /src
RUN apk add --no-cache ca-certificates git

# 拷贝模块文件
COPY go.mod go.sum* ./
RUN go mod download

# 拷贝源代码并构建
COPY . .
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -trimpath -ldflags="-s -w" -o /app/mock-llm .

# 运行阶段：使用 alpine 轻量级镜像
FROM alpine:3.21

RUN apk add --no-cache ca-certificates tzdata && \
    addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

WORKDIR /app
COPY --from=builder --chown=appuser:appuser /app/mock-llm /app/mock-llm

# 暴露服务端口（与 mock-llm 一致）
EXPOSE 30000

USER appuser
ENTRYPOINT ["/app/mock-llm"]



# 构建镜像
# docker build --platform linux/amd64 -t mock-llm:latest -f mock-llm/dockerfile mock-llm/
# docker build -t mock-llm:latest .
# 本地测试
# docker run -d -p 30000:30000 mock-llm:latest

# 标记镜像
# docker tag mock-llm:latest default-artifact.tencentcloudcr.com/dev/mock-llm:v1.0.1
    
# 推送到镜像仓库
# docker push default-artifact.tencentcloudcr.com/dev/mock-llm:v1.0.1



# kubectl create secret docker-registry tencent-registry-secret \
#   --docker-server=default-artifact.tencentcloudcr.com \
#   --docker-username='tcr$tenyunw' \
#   --docker-password='RSw2KCGXdOh00S43KozQTwEr9Kp2BrJu' \
#   --docker-email='your-email@example.com' \
#   -n default