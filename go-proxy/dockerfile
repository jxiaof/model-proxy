# 构建阶段
FROM golang:1.25-alpine3.21 AS builder

WORKDIR /src
RUN apk add --no-cache ca-certificates git

# 拷贝模块文件
COPY go.mod go.sum* ./
RUN go mod download

# 拷贝源代码并构建
COPY . .
RUN CGO_ENABLED=0 GOOS=linux GOARCH=amd64 \
    go build -trimpath -ldflags="-s -w" -o /app/proxy .

# 运行阶段：使用 alpine 轻量级镜像
FROM alpine:3.21

RUN apk add --no-cache ca-certificates tzdata && \
    addgroup -g 1000 appuser && \
    adduser -D -u 1000 -G appuser appuser

WORKDIR /app
COPY --from=builder --chown=appuser:appuser /app/proxy /app/proxy

# 暴露服务端口（与部署配置一致）
EXPOSE 9000

USER appuser

ENTRYPOINT ["/app/proxy"]

# docker build --platform linux/amd64 -t model_proxy:latest .
# docker run -d -p 9000:9000 model_proxy:latest

# docker tag model_proxy:latest default-artifact.tencentcloudcr.com/dev/model_proxy:v1.0.11
# docker push default-artifact.tencentcloudcr.com/dev/model_proxy:v1.0.11



# apiVersion: v1
# kind: Secret
# metadata:
#   name: tencent-registry-secret
#   namespace: default
# type: kubernetes.io/dockerconfigjson
# stringData:
#   .dockerconfigjson: |
#     {
#       "auths": {
#         "default-artifact.tencentcloudcr.com": {
#           "username": "tcr$tenyunw",
#           "password": "RSw2KCGXdOh00S43KozQTwEr9Kp2BrJu",
#           "email": "your-email@example.com",
#           "auth": "dGNyJHRlbnl1bnc6UlN3MktDR1hkT2gwMFM0M0tvelFUd0VyOUtwMkJySnU="
#         }
#       }
#     }


# kubectl create secret docker-registry tencent-registry-secret \
#   --docker-server=default-artifact.tencentcloudcr.com \
#   --docker-username='tcr$tenyunw' \
#   --docker-password='RSw2KCGXdOh00S43KozQTwEr9Kp2BrJu' \
#   --docker-email='your-email@example.com' \
#   -n default

# curl -X POST "http://localhost:9000/v1/chat/completions" \
#   -H "Content-Type: application/json" \
#   -d '{
#     "model": "Qwen3-8B",
#     "messages": [{"role": "user", "content": "请解释量子力学"}],
#     "thinking": true,
#     "max_tokens": 2000
#   }'